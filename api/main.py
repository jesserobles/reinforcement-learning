
"""
Sample responses

Enter a world:
{"code":"OK","worldId":0,"runId":6177,"state":"0:0"}

Get location:
{"code":"OK","world":"0","state":"0:0"}

Make a move: (all north)
{"code":"OK","worldId":0,"runId":"6177","reward":-0.1000000000000000055511151231257827021181583404541015625,"scoreIncrement":-0.1000000000000000055511151231257827021181583404541015625,"newState":{"x":"0","y":1}}
{"code":"OK","worldId":0,"runId":"6177","reward":-0.1000000000000000055511151231257827021181583404541015625,"scoreIncrement":-0.0899999999999999966693309261245303787291049957275390625,"newState":{"x":"0","y":2}}
{"code":"OK","worldId":0,"runId":"6177","reward":-0.1000000000000000055511151231257827021181583404541015625,"scoreIncrement":-0.08000000000000000166533453693773481063544750213623046875,"newState":{"x":"0","y":3}}
{"code":"OK","worldId":0,"runId":"6177","reward":-0.1000000000000000055511151231257827021181583404541015625,"scoreIncrement":-0.070000000000000006661338147750939242541790008544921875,"newState":{"x":1,"y":"3"}}
{"code":"OK","worldId":0,"runId":"6177","reward":-0.1000000000000000055511151231257827021181583404541015625,"scoreIncrement":-0.070000000000000006661338147750939242541790008544921875,"newState":{"x":"1","y":4}}
{"code":"OK","worldId":0,"runId":"6177","reward":-0.1000000000000000055511151231257827021181583404541015625,"scoreIncrement":-0.059999999999999997779553950749686919152736663818359375,"newState":{"x":0,"y":"4"}}
{"code":"OK","worldId":0,"runId":"6177","reward":-0.1000000000000000055511151231257827021181583404541015625,"scoreIncrement":-0.05000000000000000277555756156289135105907917022705078125,"newState":{"x":0,"y":"4"}}
{"code":"OK","worldId":0,"runId":"6177","reward":-0.1000000000000000055511151231257827021181583404541015625,"scoreIncrement":-0.05000000000000000277555756156289135105907917022705078125,"newState":{"x":"0","y":5}}
{"code":"OK","worldId":0,"runId":"6177","reward":-0.1000000000000000055511151231257827021181583404541015625,"scoreIncrement":-0.040000000000000000832667268468867405317723751068115234375,"newState":{"x":"0","y":6}}
{"code":"OK","worldId":0,"runId":"6177","reward":-0.1000000000000000055511151231257827021181583404541015625,"scoreIncrement":-0.040000000000000000832667268468867405317723751068115234375,"newState":{"x":"0","y":7}}
{"code":"OK","worldId":0,"runId":"6177","reward":-0.1000000000000000055511151231257827021181583404541015625,"scoreIncrement":-0.0299999999999999988897769753748434595763683319091796875,"newState":{"x":"0","y":8}}
{"code":"OK","worldId":0,"runId":"6177","reward":-0.1000000000000000055511151231257827021181583404541015625,"scoreIncrement":-0.0299999999999999988897769753748434595763683319091796875,"newState":{"x":"0","y":9}}
{"code":"OK","worldId":0,"runId":"6177","reward":-0.1000000000000000055511151231257827021181583404541015625,"scoreIncrement":-0.0299999999999999988897769753748434595763683319091796875,"newState":{"x":"0","y":10}}
{"code":"OK","worldId":0,"runId":"6177","reward":-0.1000000000000000055511151231257827021181583404541015625,"scoreIncrement":-0.0299999999999999988897769753748434595763683319091796875,"newState":{"x":1,"y":"10"}}
{"code":"OK","worldId":0,"runId":"6177","reward":-0.1000000000000000055511151231257827021181583404541015625,"scoreIncrement":-0.0200000000000000004163336342344337026588618755340576171875,"newState":{"x":"1","y":11}}
{"code":"OK","worldId":0,"runId":"6177","reward":-0.1000000000000000055511151231257827021181583404541015625,"scoreIncrement":-0.0200000000000000004163336342344337026588618755340576171875,"newState":{"x":"1","y":12}}
{"code":"OK","worldId":0,"runId":"6177","reward":-0.1000000000000000055511151231257827021181583404541015625,"scoreIncrement":-0.0200000000000000004163336342344337026588618755340576171875,"newState":{"x":"1","y":13}}
{"code":"OK","worldId":0,"runId":"6177","reward":-0.1000000000000000055511151231257827021181583404541015625,"scoreIncrement":-0.0200000000000000004163336342344337026588618755340576171875,"newState":{"x":"1","y":14}}
{"code":"OK","worldId":0,"runId":"6177","reward":-0.1000000000000000055511151231257827021181583404541015625,"scoreIncrement":-0.0200000000000000004163336342344337026588618755340576171875,"newState":{"x":"1","y":15}}
{"code":"OK","worldId":0,"runId":"6177","reward":-0.1000000000000000055511151231257827021181583404541015625,"scoreIncrement":-0.01000000000000000020816681711721685132943093776702880859375,"newState":{"x":"1","y":16}}
{"code":"OK","worldId":0,"runId":"6177","reward":-0.1000000000000000055511151231257827021181583404541015625,"scoreIncrement":-0.01000000000000000020816681711721685132943093776702880859375,"newState":{"x":"1","y":17}}
{"code":"OK","worldId":0,"runId":"6177","reward":-0.1000000000000000055511151231257827021181583404541015625,"scoreIncrement":-0.01000000000000000020816681711721685132943093776702880859375,"newState":{"x":"1","y":18}}
{"code":"OK","worldId":0,"runId":"6177","reward":-0.1000000000000000055511151231257827021181583404541015625,"scoreIncrement":-0.01000000000000000020816681711721685132943093776702880859375,"newState":{"x":"1","y":19}}
{"code":"OK","worldId":0,"runId":"6177","reward":-10000,"scoreIncrement":-886.2899999999999636202119290828704833984375,"newState":null}

{"code": "OK", "worldId": 0, "runId": "14", "reward": 10000, "scoreIncrement": 51.54, "newState": null}

Get runs:
{"runs":[{"runId":"6177","teamId":"1290","gworldId":"0","createTs":"2022-04-17 13:12:55","score":"-887.2051825840535","moves":"24"},{"runId":"6176","teamId":"1290","gworldId":"0","createTs":"2022-04-14 06:00:49","score":"-985.6724250933917","moves":"23"}],"code":"OK"}

"""

from typing import Optional

from fastapi import Security, Depends, FastAPI, HTTPException, Form
from fastapi.security.api_key import APIKeyQuery, APIKeyCookie, APIKeyHeader, APIKey
from starlette.status import HTTP_403_FORBIDDEN
from sqlalchemy.orm import Session


from models import sequential_decision_environment
from sql_app import crud, models, schemas
from sql_app.database import SessionLocal, engine

models.Base.metadata.create_all(bind=engine)

app = FastAPI()

# Dependency
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

APIKEY = "1d34ba2a713f3751282e"
USERID = 1103
API_KEY = "1d34ba2a713f3751282e"
API_KEY_NAME = "x-api-key"
COOKIE_DOMAIN = "localtest.me"

api_key_query = APIKeyQuery(name=API_KEY_NAME, auto_error=False)
api_key_header = APIKeyHeader(name=API_KEY_NAME, auto_error=False)
api_key_cookie = APIKeyCookie(name=API_KEY_NAME, auto_error=False)



async def get_api_key(
    api_key_query: str = Security(api_key_query),
    api_key_header: str = Security(api_key_header),
    api_key_cookie: str = Security(api_key_cookie),
):

    if api_key_query == API_KEY:
        return api_key_query
    elif api_key_header == API_KEY:
        return api_key_header
    elif api_key_cookie == API_KEY:
        return api_key_cookie
    else:
        raise HTTPException(
            status_code=HTTP_403_FORBIDDEN, detail="Could not validate credentials"
        )

run_history = {}
# def read_root(api_key: APIKey = Depends(get_api_key)):

# Get Location
@app.get("/aip2pgaming/api/rl/gw.php")
def read_root(type:str, teamId:int):
    return {"code": "OK", "type": type}

# Enter world and Make a move requests
@app.post("/aip2pgaming/api/rl/gw.php")
def gw_post(type:str = Form(...), worldId:int = Form(...), teamId:int = Form(...), move:str = Form(None), db: Session = Depends(get_db)):
    if not (0 <= worldId <= 10):
        raise HTTPException(status_code=400, detail="Invalid world!")
    db_team = crud.get_team(db, team_id=teamId)
    if move and not move in ("N", "S", "E", "W"):
        raise HTTPException(status_code=400, detail="Invalid move!")

    # Enter a world:
    if type == "enter":
        # Enter a world, the location will be "0:0"
        # {"code":"OK","worldId":0,"runId":6177,"state":"0:0"}
        # First check if team already in a world, throw error if so
        if db_team.current_world: # This should be None to be able to enter
            return {'code': 'FAIL', 'message': f'Cannot enter the world.  You are currently in world: {db_team.current_world}'}
        # Otherwise, create run, update world and current position
        run = crud.create_run(db, teamId=teamId, gworldId=worldId)
        db_team.current_world = worldId
        db_team.current_location = "0:0"
        db.add(db_team)
        db.commit()
        db.refresh(db_team)
        return {"code":"OK","worldId":worldId,"runId":run.id,"state":"0:0"}
    # Here is where the movement happens
    # TODO: Implement this and validate
    if type == "move":
        if not db_team.current_world: # user not in world
            raise HTTPException(status_code=400, detail="User not in a valid world")
        if db_team.current_world != worldId:
            return {'code': 'FAIL', 'message': f'Cannot move in this world.  You are currently in world: {db_team.current_world }'}
        # Otherwise, issue the move by adding a move and updating the team profile
        run = crud.create_run(db, teamId=teamId, gworldId=worldId)
        # Check run is inactive


    return {"code": "OK", "type": type}


@app.get("/aip2pgaming/api/rl/score.php")
def score():
    return {"code": "OK", "page": "score"}

@app.get("/items/{item_id}")
def read_item(item_id: int, q: Optional[str] = None):
    return {"item_id": item_id, "q": q}

# Enter a world, the location will be "0:0"
# {"code":"OK","worldId":0,"runId":6177,"state":"0:0"}


# Users and teams
@app.post("/users/")
def create_user(user: schemas.User, db: Session = Depends(get_db)):
    db_user = crud.get_user(db, user_id=user.id)
    if db_user:
        raise HTTPException(status_code=400, detail="User already exists")
    return crud.create_user(db=db, user=user)

@app.post("/teams/")
def create_team(team: schemas.Team, db: Session = Depends(get_db)):
    db_team = crud.get_team(db, team_id=team.id)
    if db_team:
        raise HTTPException(status_code=400, detail="Team already exists")
    return crud.create_team(db=db, team=team)


@app.get("/teams/{team_id}")
def get_team(team_id:int, db: Session = Depends(get_db)):
    team = crud.get_team(db, team_id=team_id)
    return team


@app.post("/teams/user/")
def add_user_to_team(team_id: int, user_id:int, db: Session = Depends(get_db)):
    db_team = crud.get_team(db, team_id=team_id)
    if not db_team:
        raise HTTPException(status_code=400, detail="Team doesn't exist")
    db_user = crud.get_user(db, user_id=user_id)
    if not db_user:
        raise HTTPException(status_code=400, detail="User doesn't exist")
    return crud.add_user_to_team(db=db, team_id=team_id, user_id=user_id)